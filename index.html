<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½åº“ v20 - å¯¼å…¥ä¿®å¤ç‰ˆ</title>
    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/docx-preview/dist/docx-preview.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --bg: #f8fafc; --danger: #ef4444; --success: #10b981; }
        body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: #1e293b; overflow-x: hidden; }
        .nav-header { position: sticky; top: 0; background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; z-index: 100; }
        
        /* é¢„è§ˆå±‚è®¾è®¡ */
        #preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .close-bar { padding: 12px; background: rgba(30, 41, 59, 0.95); color: white; text-align: center; font-weight: bold; z-index: 2100; cursor: pointer; }
        
        /* æ»šåŠ¨å®¹å™¨ */
        #viewer-scroll-area { flex: 1; overflow: auto; -webkit-overflow-scrolling: touch; background: #333; position: relative; }
        #viewer-content { transform-origin: 0 0; display: flex; flex-direction: column; align-items: center; padding: 10px; min-width: 100%; }
        
        .pdf-page { margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); background: white; max-width: 95vw; }
        #text-box { padding: 20px; background: white; white-space: pre-wrap; word-break: break-all; width: 90vw; }

        /* ä¸»ç•Œé¢æ ·å¼ */
        .container { padding: 10px; padding-bottom: 80px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .doc-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; }
        .item-actions { display: flex; gap: 8px; margin-top: 10px; }
        .btn-sm { flex: 1; padding: 10px; border-radius: 6px; font-size: 13px; border: none; cursor: pointer; background: #f1f5f9; }
        .btn-success { background: var(--success); color: white; }
        .edit-panel { background: #fffbeb; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid #fef08a; display: none; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        #status-msg { font-size: 12px; text-align: center; padding: 5px; color: var(--primary); }
    </style>
</head>
<body>

<div class="nav-header">å…¨èƒ½åº“ v20</div>

<div id="preview-overlay">
    <div class="close-bar" onclick="closePreview()">âœ• å…³é—­é¢„è§ˆ (æ”¯æŒåŒæŒ‡ç¼©æ”¾)</div>
    <div id="viewer-scroll-area">
        <div id="viewer-content">
            <div id="text-box" style="display:none;"></div>
        </div>
    </div>
</div>

<div class="container">
    <div id="status-msg"></div>
    <div class="card">
        <input type="text" id="docTags" placeholder="é¢„è®¾æ ‡ç­¾">
        <textarea id="docNote" placeholder="å¤‡æ³¨..." rows="1"></textarea>
        <input type="file" id="fileInput" accept=".pdf,.docx,.txt" multiple style="display:none" onchange="handleFileSelect()">
        <div style="border:2px dashed #3b82f6; padding:20px; text-align:center; color:#3b82f6; cursor:pointer;" onclick="document.getElementById('fileInput').click()">
            <strong>ï¼‹ é€‰æ‹©æ–‡æ¡£</strong>
        </div>
        <div id="selected-list" style="margin-top:10px;"></div>
        <button id="uploadBtn" style="display:none; width:100%; padding:14px; background:var(--primary); color:white; border:none; border-radius:8px; margin-top:10px; font-weight:bold;" onclick="saveBatchDocs()">å¼€å§‹ä¸Šä¼ å­˜åº“</button>
    </div>

    <div class="card">
        <input type="search" id="searchInput" placeholder="ğŸ” æœç´¢æ–‡æ¡£..." oninput="renderList(this.value)">
        <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="btn-sm" onclick="exportJSON()">å¤‡ä»½å…¨é‡æ•°æ®</button>
            <button class="btn-sm" onclick="document.getElementById('importIn').click()">å¯¼å…¥ JSON æ¢å¤</button>
            <input type="file" id="importIn" accept=".json" style="display:none" onchange="importJSON(this)">
        </div>
    </div>

    <ul id="doc-list" style="padding:0; list-style:none;"></ul>
</div>

<script>
    let db;
    let selectedFiles = [];
    let currentScale = 1;
    // å¼ºåˆ¶ç»Ÿä¸€ Store åç§°ï¼Œç¡®ä¿å¯¼å…¥å¯¼å‡ºä¸æ’è½¦
    const STORE_NAME = "universal_doc_store";
    const DB_NAME = "SuperDatabaseV20";
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => { 
        db = e.target.result; 
        if(!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true }); 
        }
    };
    request.onsuccess = e => { db = e.target.result; renderList(); };

    function showMsg(txt) { document.getElementById('status-msg').innerText = txt; setTimeout(()=> document.getElementById('status-msg').innerText="", 3000); }

    // --- ä¸Šä¼ é€»è¾‘ ---
    function handleFileSelect() {
        selectedFiles = [...selectedFiles, ...Array.from(document.getElementById('fileInput').files)];
        const list = document.getElementById('selected-list');
        const btn = document.getElementById('uploadBtn');
        list.innerHTML = selectedFiles.map((f, i) => `<div style="font-size:13px; padding:5px; border-bottom:1px solid #eee;">ğŸ“„ ${f.name} <span style="color:red; float:right; cursor:pointer" onclick="removeFile(${i})">ç§»é™¤</span></div>`).join('');
        list.style.display = btn.style.display = selectedFiles.length ? 'block' : 'none';
    }
    function removeFile(i) { selectedFiles.splice(i, 1); handleFileSelect(); }

    async function saveBatchDocs() {
        const tags = document.getElementById('docTags').value.split(' ').filter(t => t);
        const note = document.getElementById('docNote').value;
        const tasks = [...selectedFiles];
        selectedFiles = []; handleFileSelect(); 

        for (const file of tasks) {
            const content = await file.arrayBuffer();
            const type = file.name.endsWith('.docx') ? 'word' : (file.name.endsWith('.txt') ? 'txt' : 'pdf');
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).add({ title: file.name, type, tags, note, content });
        }
        renderList();
        showMsg("ä¸Šä¼ å®Œæˆ");
    }

    function renderList(kw = "") {
        const listEl = document.getElementById('doc-list'); listEl.innerHTML = "";
        const tx = db.transaction(STORE_NAME, "readonly");
        tx.objectStore(STORE_NAME).openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) {
                const doc = cursor.value;
                if (doc.title.toLowerCase().includes(kw.toLowerCase())) {
                    const li = document.createElement('li');
                    li.className = 'doc-item';
                    li.innerHTML = `
                        <div id="v-${doc.id}">
                            <strong>${doc.title}</strong>
                            <div class="item-actions">
                                <button class="btn-sm" onclick="openDoc(${doc.id})">é¢„è§ˆ</button>
                                <button class="btn-sm" onclick="showEdit(${doc.id})">ç¼–è¾‘</button>
                                <button class="btn-sm" onclick="downloadDoc(${doc.id})">ä¸‹è½½</button>
                                <button class="btn-sm" style="color:red" onclick="deleteDoc(${doc.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        <div id="e-${doc.id}" class="edit-panel">
                            <input type="text" id="et-${doc.id}" value="${doc.title}">
                            <textarea id="en-${doc.id}">${doc.note || ''}</textarea>
                            <button class="btn-sm btn-success" onclick="saveEdit(${doc.id})">ç¡®å®šä¿å­˜</button>
                        </div>`;
                    listEl.appendChild(li);
                }
                cursor.continue();
            }
        };
    }

    function showEdit(id) { document.getElementById(`e-${id}`).style.display = 'block'; document.getElementById(`v-${id}`).style.display = 'none'; }
    function saveEdit(id) {
        const store = db.transaction(STORE_NAME, "readwrite").objectStore(STORE_NAME);
        store.get(id).onsuccess = e => {
            const d = e.target.result;
            d.title = document.getElementById(`et-${id}`).value;
            d.note = document.getElementById(`en-${id}`).value;
            store.put(d).onsuccess = () => renderList();
        };
    }

    // --- æ ¸å¿ƒæ‰‹åŠ¿ ---
    const area = document.getElementById('viewer-scroll-area');
    const content = document.getElementById('viewer-content');
    let startDist = 0;
    let baseScale = 1;

    area.addEventListener('touchstart', e => {
        if (e.touches.length === 2) {
            e.preventDefault();
            startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            baseScale = currentScale;
        }
    }, { passive: false });

    area.addEventListener('touchmove', e => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const currentDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            currentScale = Math.min(Math.max(baseScale * (currentDist / startDist), 0.5), 4);
            content.style.transform = `scale(${currentScale})`;
        }
    }, { passive: false });

    async function openDoc(id) {
        db.transaction(STORE_NAME).objectStore(STORE_NAME).get(id).onsuccess = async e => {
            const doc = e.target.result;
            document.getElementById('preview-overlay').style.display = 'flex';
            content.innerHTML = '<div id="text-box" style="display:none;"></div>';
            const textBox = document.getElementById('text-box');
            currentScale = 1; content.style.transform = `scale(1)`;
            if (doc.type === 'pdf') {
                const pdf = await pdfjsLib.getDocument({data: doc.content}).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const vp = page.getViewport({scale: 1.5});
                    const canvas = document.createElement('canvas');
                    canvas.className = 'pdf-page';
                    canvas.width = vp.width; canvas.height = vp.height;
                    await page.render({canvasContext: canvas.getContext('2d'), viewport: vp}).promise;
                    content.appendChild(canvas);
                }
            } else if (doc.type === 'word') {
                content.style.background = "white";
                await docx.renderAsync(doc.content, content);
            } else if (doc.type === 'txt') {
                textBox.style.display = "block";
                textBox.innerText = new TextDecoder().decode(doc.content);
                content.appendChild(textBox);
                content.style.background = "white";
            }
        };
    }

    function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }
    
    function downloadDoc(id) {
        db.transaction(STORE_NAME).objectStore(STORE_NAME).get(id).onsuccess = e => {
            const a = document.createElement('a');
            const blob = new Blob([e.target.result.content]);
            a.href = URL.createObjectURL(blob);
            a.download = e.target.result.title; a.click();
        };
    }

    function deleteDoc(id) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) db.transaction(STORE_NAME,"readwrite").objectStore(STORE_NAME).delete(id).onsuccess=()=>renderList(); }

    // --- ä¿®å¤åçš„å¯¼å…¥å¯¼å‡º ---
    async function exportJSON() {
        const tx = db.transaction(STORE_NAME, "readonly");
        const docs = [];
        tx.objectStore(STORE_NAME).openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if(cursor) {
                const item = cursor.value;
                // å°† ArrayBuffer è½¬ä¸º Base64
                const b64 = btoa(new Uint8Array(item.content).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                docs.push({...item, content: b64}); 
                cursor.continue();
            } else {
                const blob = new Blob([JSON.stringify(docs)], {type: "application/json"});
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob);
                a.download = `Backup_${new Date().getTime()}.json`; 
                a.click();
                showMsg("å¯¼å‡ºæˆåŠŸ");
            }
        };
    }

    function importJSON(input) {
        if (!input.files.length) return;
        showMsg("æ­£åœ¨å¯¼å…¥...");
        const reader = new FileReader();
        reader.onload = async e => {
            try {
                const data = JSON.parse(e.target.result);
                if (!Array.isArray(data)) throw new Error("æ— æ•ˆçš„ JSON æ ¼å¼");
                
                const tx = db.transaction(STORE_NAME, "readwrite");
                const store = tx.objectStore(STORE_NAME);
                
                data.forEach(it => {
                    const bin = atob(it.content);
                    const bytes = new Uint8Array(bin.length);
                    for(let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    // ç§»é™¤æ—§ ID è®©æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆæ–° IDï¼Œé˜²æ­¢å†²çª
                    const newItem = {
                        title: it.title,
                        type: it.type,
                        tags: it.tags || [],
                        note: it.note || "",
                        content: bytes.buffer
                    };
                    store.add(newItem);
                });
                
                tx.oncomplete = () => {
                    showMsg("âœ… å¯¼å…¥æˆåŠŸï¼");
                    renderList();
                    input.value = "";
                };
                tx.onerror = () => showMsg("âŒ å†™å…¥æ•°æ®åº“å¤±è´¥");
            } catch (err) {
                console.error(err);
                showMsg("âŒ å¯¼å…¥å¤±è´¥: " + err.message);
            }
        };
        reader.readAsText(input.files[0]);
    }
</script>
</body>
</html>