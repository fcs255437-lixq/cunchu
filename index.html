<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½åº“ v35 - ç»ˆæä¿®å¤ç‰ˆ</title>
    
    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/docx-preview/dist/docx-preview.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        :root { --p: #3b82f6; --bg: #f8fafc; --s: #10b981; --d: #ef4444; }
        body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: #1e293b; padding-bottom: 50px; }
        .nav { position: sticky; top: 0; background: var(--p); color: white; padding: 15px; text-align: center; font-weight: bold; z-index: 100; }
        .container { padding: 12px; max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* é¢„è§ˆçª— */
        #ov { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .bar { padding: 12px; background: #1e293b; color: white; text-align: center; cursor: pointer; }
        #v-area { flex: 1; overflow: auto; background: #333; }
        #v-content { display: flex; flex-direction: column; align-items: center; padding: 10px; min-width: 100%; }
        
        /* ç¼–è¾‘é¢æ¿æ ·å¼ */
        .edit-box { background: #fffbeb; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #fef08a; display: none; }
        
        /* UI å…ƒç´  */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-s:disabled { background: #cbd5e1; }
        .btn-sm { flex: 1; padding: 10px; font-size: 13px; border-radius: 6px; background: #f1f5f9; border: none; cursor: pointer; }
        
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .doc-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #eef2f6; }
        .tag { display: inline-block; background: #e0f2fe; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin: 4px 4px 0 0; color: #0369a1; }
        .note { font-size: 12px; color: #64748b; margin-top: 8px; background: #f8fafc; padding: 8px; border-radius: 4px; border-left: 3px solid #cbd5e1; }
        canvas { max-width: 100%; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="nav">å…¨èƒ½ç¦»çº¿ç®¡ç†åº“ v35</div>

<div id="ov">
    <div class="bar" onclick="closeV()">âœ• å…³é—­é¢„è§ˆ</div>
    <div id="v-area"><div id="v-content"></div></div>
</div>

<div class="container">
    <div id="db-status" style="font-size:11px; text-align:right; margin-bottom:5px; color:orange;">æ­£åœ¨åŠ è½½æ•°æ®åº“...</div>

    <div class="card">
        <input type="text" id="t-in" placeholder="è®¾ç½®æ ‡ç­¾ (ç©ºæ ¼åˆ†éš”)">
        <textarea id="n-in" placeholder="æ·»åŠ å¤‡æ³¨..." rows="1"></textarea>
        <div style="border:2px dashed var(--p); border-radius:8px; padding:25px; text-align:center; color:var(--p); cursor:pointer;" onclick="document.getElementById('f-in').click()">
            <strong>ï¼‹ é€‰æ‹©æ–‡æ¡£</strong>
            <input type="file" id="f-in" accept=".pdf,.docx,.xlsx,.txt" multiple style="display:none" onchange="handleSel()">
        </div>
        <div id="sel-list" style="margin-top:10px;"></div>
        <button id="up-btn" class="btn btn-s" style="display:none;" disabled onclick="doSave()">å­˜å…¥åº“</button>
    </div>

    <div class="card">
        <input type="search" id="search-in" placeholder="ğŸ” æœç´¢æ–‡ä»¶åã€æ ‡ç­¾æˆ–å¤‡æ³¨..." oninput="render(this.value)">
        <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="btn-sm" onclick="doExp()">å¯¼å‡ºå¤‡ä»½</button>
            <button class="btn-sm" onclick="document.getElementById('im-in').click()">æ¢å¤å¯¼å…¥</button>
            <input type="file" id="im-in" accept=".json" style="display:none" onchange="doImp(this)">
        </div>
    </div>

    <div id="main-list"></div>
</div>

<script>
    let db = null;
    let selFiles = [];
    const DBNAME = "SuperDocBox_v35", STORE = "docs";

    const req = indexedDB.open(DBNAME, 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore(STORE, {keyPath:"id", autoIncrement:true});
    req.onsuccess = e => { 
        db = e.target.result; 
        document.getElementById('db-status').innerText = "â— ç¦»çº¿åº“å°±ç»ª";
        document.getElementById('db-status').style.color = "green";
        render(); 
    };

    function handleSel() {
        selFiles = [...selFiles, ...Array.from(document.getElementById('f-in').files)];
        const list = document.getElementById('sel-list');
        list.innerHTML = selFiles.map((f, i) => `<div style="font-size:13px;padding:5px;">ğŸ“„ ${f.name}</div>`).join('');
        const btn = document.getElementById('up-btn');
        btn.style.display = selFiles.length ? 'block' : 'none';
        if(db) { btn.disabled = false; btn.innerText = "å¼€å§‹å­˜å…¥"; }
    }

    async function doSave() {
        if(!db) return;
        const tags = document.getElementById('t-in').value.split(' ').filter(t => t);
        const note = document.getElementById('n-in').value;
        for (let f of selFiles) {
            const buf = await f.arrayBuffer();
            const type = f.name.split('.').pop().toLowerCase();
            await new Promise(res => {
                const tx = db.transaction(STORE, "readwrite");
                tx.objectStore(STORE).add({ title: f.name, type, tags, note, content: buf });
                tx.oncomplete = res;
            });
        }
        selFiles = []; document.getElementById('f-in').value = ""; 
        document.getElementById('t-in').value = ""; document.getElementById('n-in').value = "";
        handleSel(); render();
    }

    function render(kw = "") {
        const out = document.getElementById('main-list');
        out.innerHTML = "";
        if(!db) return;
        db.transaction(STORE).objectStore(STORE).openCursor().onsuccess = e => {
            const c = e.target.result;
            if(c) {
                const d = c.value;
                if((d.title + d.tags.join('') + d.note).toLowerCase().includes(kw.toLowerCase())) {
                    const div = document.createElement('div');
                    div.className = 'doc-item';
                    div.innerHTML = `
                        <div id="v-view-${d.id}">
                            <div style="font-weight:bold;">ğŸ“„ ${d.title}</div>
                            <div>${d.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>
                            ${d.note ? `<div class="note">${d.note}</div>` : ''}
                            <div style="display:flex; gap:8px; margin-top:12px;">
                                <button class="btn-sm" onclick="openDoc(${d.id})">é¢„è§ˆ</button>
                                <button class="btn-sm" onclick="dl(${d.id})">ä¸‹è½½</button>
                                <button class="btn-sm" onclick="showEdit(${d.id})">ç¼–è¾‘</button>
                                <button class="btn-sm" style="color:var(--d)" onclick="del(${d.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        <div id="v-edit-${d.id}" class="edit-box">
                            <input type="text" id="et-${d.id}" value="${d.title}">
                            <textarea id="en-${d.id}">${d.note || ''}</textarea>
                            <button class="btn-sm" style="background:var(--s);color:white;width:100%" onclick="saveEdit(${d.id})">ä¿å­˜ä¿®æ”¹</button>
                        </div>`;
                    out.prepend(div);
                }
                c.continue();
            }
        };
    }

    // --- ç¼–è¾‘é€»è¾‘ ---
    function showEdit(id) {
        document.getElementById(`v-view-${id}`).style.display = 'none';
        document.getElementById(`v-edit-${id}`).style.display = 'block';
    }

    function saveEdit(id) {
        const store = db.transaction(STORE, "readwrite").objectStore(STORE);
        store.get(id).onsuccess = e => {
            const data = e.target.result;
            data.title = document.getElementById(`et-${id}`).value;
            data.note = document.getElementById(`en-${id}`).value;
            store.put(data).onsuccess = () => render();
        };
    }

    // --- å…¶ä»–åŠŸèƒ½ ---
    async function openDoc(id) {
        db.transaction(STORE).objectStore(STORE).get(id).onsuccess = async e => {
            const doc = e.target.result;
            document.getElementById('ov').style.display = 'flex';
            const vc = document.getElementById('v-content');
            vc.innerHTML = "è§£æä¸­...";
            if(doc.type === 'pdf') {
                vc.innerHTML = "";
                const pdf = await pdfjsLib.getDocument({data: doc.content}).promise;
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const canvas = document.createElement('canvas');
                    const vp = page.getViewport({scale: 1.5});
                    canvas.width = vp.width; canvas.height = vp.height;
                    await page.render({canvasContext: canvas.getContext('2d'), viewport: vp}).promise;
                    vc.appendChild(canvas);
                }
            } else if(doc.type === 'docx') {
                vc.style.background = "#fff"; vc.innerHTML = "";
                await docx.renderAsync(doc.content, vc);
            } else if(doc.type === 'xlsx') {
                vc.style.background = "#fff";
                const wb = XLSX.read(doc.content, {type:'array'});
                vc.innerHTML = `<div style="padding:20px;">${XLSX.utils.sheet_to_html(wb.Sheets[wb.SheetNames[0]])}</div>`;
            } else {
                vc.style.background = "#fff"; 
                vc.innerHTML = `<pre style="padding:20px;white-space:pre-wrap;">${new TextDecoder().decode(doc.content)}</pre>`;
            }
        };
    }

    function closeV() { document.getElementById('ov').style.display = 'none'; }
    function dl(id) {
        db.transaction(STORE).objectStore(STORE).get(id).onsuccess = e => {
            const d = e.target.result;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([d.content]));
            a.download = d.title; a.click();
        };
    }
    function del(id) { if(confirm("åˆ é™¤?")) db.transaction(STORE,"readwrite").objectStore(STORE).delete(id).onsuccess=()=>render(); }

    function doExp() {
        const data = [];
        db.transaction(STORE).objectStore(STORE).openCursor().onsuccess = e => {
            const c = e.target.result;
            if(c) {
                const b64 = btoa(new Uint8Array(c.value.content).reduce((acc, b) => acc + String.fromCharCode(b), ''));
                data.push({...c.value, content: b64}); c.continue();
            } else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([JSON.stringify(data)]));
                a.download = "ç¦»çº¿å¤‡ä»½.json"; a.click();
            }
        };
    }

    function doImp(input) {
        const fr = new FileReader();
        fr.onload = e => {
            const data = JSON.parse(e.target.result);
            const tx = db.transaction(STORE, "readwrite");
            data.forEach(it => {
                const bin = atob(it.content);
                const buf = new Uint8Array(bin.length);
                for(let i=0; i<bin.length; i++) buf[i] = bin.charCodeAt(i);
                delete it.id; it.content = buf.buffer;
                tx.objectStore(STORE).add(it);
            });
            tx.oncomplete = () => render();
        };
        fr.readAsText(input.files[0]);
    }
</script>
</body>
</html>
